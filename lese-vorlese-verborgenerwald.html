<script>
let currentSpeech = null;
let isReading = false;
let currentLanguage = 'de';
let availableVoices = [];

// Spracheinstellungen
const languageTexts = {
    de: {
        title: "Das Geheimnis des verborgenen Waldes",
        author: "von Helmut Wegner",
        btnRead: "Vorlesen starten",
        btnStop: "Stoppen",
        lang: "de-DE",
        startMessage: "Vorlesen gestartet! üîä",
        stopMessage: "Vorlesen gestoppt. ‚èπÔ∏è",
        errorMessage: "Fehler: Vorlesen wird von diesem Browser nicht unterst√ºtzt.",
        noVoiceMessage: "Hinweis: Keine deutsche Stimme verf√ºgbar. Verwende Standardstimme."
    },
    en: {
        title: "The Secret of the Hidden Forest",
        author: "by Helmut Wegner",
        btnRead: "Start Reading",
        btnStop: "Stop",
        lang: "en-US",
        startMessage: "Reading started! üîä",
        stopMessage: "Reading stopped. ‚èπÔ∏è",
        errorMessage: "Error: Text-to-speech not supported by this browser.",
        noVoiceMessage: "Note: No English voice available. Using default voice."
    }
};

function loadVoices() {
    return new Promise((resolve) => {
        availableVoices = speechSynthesis.getVoices();
        
        if (availableVoices.length > 0) {
            resolve(availableVoices);
        } else {
            speechSynthesis.addEventListener('voiceschanged', function() {
                availableVoices = speechSynthesis.getVoices();
                resolve(availableVoices);
            }, { once: true });
            
            setTimeout(() => {
                availableVoices = speechSynthesis.getVoices();
                resolve(availableVoices);
            }, 1000);
        }
    });
}

function findBestVoice(targetLang) {
    if (availableVoices.length === 0) {
        return null;
    }

    let voice = availableVoices.find(v => v.lang === targetLang);
    if (voice) return voice;

    const langFamily = targetLang.split('-')[0];
    voice = availableVoices.find(v => v.lang.startsWith(langFamily));
    if (voice) return voice;

    return availableVoices[0];
}

function switchLanguage(lang) {
    stopReading();
    
    document.querySelectorAll('.language-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    document.getElementById(lang + '-content').classList.remove('hidden');
    
    document.querySelectorAll('.btn-lang').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentLanguage = lang;
    const texts = languageTexts[lang];
    document.getElementById('main-title').textContent = texts.title;
    document.getElementById('author').textContent = texts.author;
    document.getElementById('btn-read-text').textContent = texts.btnRead;
    document.getElementById('btn-stop-text').textContent = texts.btnStop;
}

function showStatus(message, isError = false) {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.textContent = message;
    statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

async function startReading() {
    if (!('speechSynthesis' in window)) {
        showStatus(languageTexts[currentLanguage].errorMessage, true);
        return;
    }

    stopReading();

    try {
        await loadVoices();

        const storyElement = document.querySelector(`#${currentLanguage}-content .story-text`);
        if (!storyElement) {
            showStatus("Fehler: Text nicht gefunden.", true);
            return;
        }

        const paragraphs = storyElement.querySelectorAll('p');
        if (paragraphs.length === 0) {
            showStatus("Fehler: Keine Textabschnitte gefunden.", true);
            return;
        }

        // NUR ERSTE 3 ABS√ÑTZE (WELTWEIT KOMPATIBEL)
        let textToRead = '';
        for (let i = 0; i < Math.min(3, paragraphs.length); i++) {
            textToRead += paragraphs[i].textContent + ' ';
        }

        if (textToRead.trim().length === 0) {
            showStatus("Fehler: Kein Text zum Vorlesen gefunden.", true);
            return;
        }

        currentSpeech = new SpeechSynthesisUtterance(textToRead.trim());
        
        const targetLang = languageTexts[currentLanguage].lang;
        const bestVoice = findBestVoice(targetLang);
        
        if (bestVoice) {
            currentSpeech.voice = bestVoice;
            currentSpeech.lang = bestVoice.lang;
        } else {
            currentSpeech.lang = targetLang;
            showStatus(languageTexts[currentLanguage].noVoiceMessage, false);
        }

        currentSpeech.rate = 0.8;
        currentSpeech.volume = 1.0;
        currentSpeech.pitch = 1.0;

        currentSpeech.onstart = function() {
            isReading = true;
            showStatus(languageTexts[currentLanguage].startMessage);
        };

        currentSpeech.onend = function() {
            isReading = false;
            currentSpeech = null;
            showStatus("Vorlesen beendet. ‚úÖ");
        };

        currentSpeech.onerror = function(event) {
            isReading = false;
            currentSpeech = null;
            console.error('Speech error:', event);
            showStatus("Fehler beim Vorlesen. Browser-Problem erkannt.", true);
        };

        try {
            speechSynthesis.speak(currentSpeech);
            
            setTimeout(() => {
                if (currentSpeech && !speechSynthesis.speaking && !speechSynthesis.pending) {
                    showStatus("Vorlesen konnte nicht gestartet werden. Browser-Einschr√§nkung.", true);
                    isReading = false;
                    currentSpeech = null;
                }
            }, 2000);
            
        } catch (error) {
            console.error('Speech synthesis error:', error);
            showStatus("Fehler: " + error.message, true);
            isReading = false;
            currentSpeech = null;
        }

    } catch (error) {
        console.error('General error:', error);
        showStatus("Unerwarteter Fehler beim Vorlesen.", true);
        isReading = false;
        currentSpeech = null;
    }
}

function stopReading() {
    if (speechSynthesis.speaking || speechSynthesis.pending) {
        speechSynthesis.cancel();
    }
    
    if (currentSpeech) {
        currentSpeech = null;
    }
    
    if (isReading) {
        isReading = false;
        showStatus(languageTexts[currentLanguage].stopMessage);
    }
}

function pauseReading() {
    // F√ºr Kompatibilit√§t mit alten Buttons - funktioniert wie stopReading
    stopReading();
}

document.addEventListener('DOMContentLoaded', async function() {
    if (!('speechSynthesis' in window)) {
        console.warn('Text-to-Speech wird von diesem Browser nicht unterst√ºtzt');
        showStatus("Vorlesen wird von diesem Browser nicht unterst√ºtzt.", true);
        
        const readBtn = document.querySelector('.btn-read');
        readBtn.style.opacity = '0.5';
        readBtn.style.cursor = 'not-allowed';
        readBtn.onclick = function() {
            showStatus("Vorlesen wird von diesem Browser nicht unterst√ºtzt.", true);
        };
    } else {
        try {
            await loadVoices();
            console.log('Verf√ºgbare Stimmen:', availableVoices.length);
        } catch (error) {
            console.error('Fehler beim Laden der Stimmen:', error);
        }
    }
});

window.addEventListener('beforeunload', function() {
    stopReading();
});

document.addEventListener('touchstart', function() {
    if (!speechSynthesis.speaking && !speechSynthesis.pending) {
        const dummySpeech = new SpeechSynthesisUtterance('');
        dummySpeech.volume = 0;
        speechSynthesis.speak(dummySpeech);
    }
}, { once: true });
</script>
